@startuml
!theme plain
top to bottom direction

skinparam packageStyle rectangle
skinparam componentStyle rectangle

actor "Usuário (Discente/Docente)" as Usuario
actor "Cliente API Externo" as ClienteAPI
actor "Operador/Dev" as Operador

package "Borda e Segurança" {
    component NginxTLS as "Nginx Reverse Proxy\n(TLS/SSL + Roteamento)"
}

package "Interface e Frontend" {
    component StreamlitUI as "Portal Acadêmico\n(Streamlit)"
    note right of StreamlitUI
      Formulários: ACC, TCC, Estágio,
      Social, Projetos, Planos
    end note
}

package "Serviços de API (Backend)" {
    component FastAPI as "FasiTech API\n(FastAPI)"
    component AuthAPIKey as "Middleware Auth\n(API Key)"
    component SocialDataService as "Social Data Service\n(Filtros + LGPD)"
}

package "Core do Sistema" {
    component FormOrchestrator as "Orquestrador de Formulários\n(form_service)"
    component Repository as "Repository\n(SQLModel)"
    
    database PostgreSQL as "PostgreSQL\n(Submissões Acadêmicas)"
}

package "Módulo de IA - Diretor Virtual (RAG)" {
    component ChatbotService as "ChatbotService\n(Agno Agent)"
    component OllamaEmbedder as "Ollama Embedder\n(nomic-embed-text)"
    
    database LanceDB as "LanceDB\n(Vetor + Cache Semântico)"
    database SQLiteHistory as "SQLite\n(Histórico de Conversas)"
    
    component LLM as "LLM Provider\n(Gemini / Maritaca / HF)"
}

package "Integrações Externas" {
    component GoogleDrive as "Google Drive\n(Armazenamento de PDFs)"
    component GoogleSheets as "Google Sheets\n(Feedback + Legado)"
    component SMTP as "SMTP Gmail\n(Notificações)"
}

package "Infraestrutura de Runtime" {
    component DockerCompose as "Docker Compose\n(dev/prod/prodUFPA)"
    component CacheVolumes as "Volumes de Cache\n(Ollama + App Cache)"
}

' Fluxos de Acesso
Usuario --> NginxTLS
ClienteAPI --> NginxTLS
NginxTLS --> StreamlitUI : "/"
NginxTLS --> FastAPI : "/api/*"

' Fluxos Streamlit
StreamlitUI --> FormOrchestrator : Envio de formulários
StreamlitUI --> ChatbotService : Consulta RAG (PPC)
StreamlitUI --> Repository : Consultas diretas

' Fluxos RAG
ChatbotService --> OllamaEmbedder : Gerar Embeddings
ChatbotService --> LanceDB : Busca Vetorial
ChatbotService --> LLM : Geração de Resposta
ChatbotService --> SQLiteHistory : Persistência de Sessão

' Fluxos API e Dados
FastAPI --> AuthAPIKey : Validação
FastAPI --> SocialDataService : Processamento
SocialDataService --> PostgreSQL : SELECT Submissions
FormOrchestrator --> GoogleDrive : Upload de anexos
FormOrchestrator --> PostgreSQL : Persistência
FormOrchestrator --> SMTP : Envio de e-mail
Repository --> PostgreSQL : CRUD Operações

' Gestão de Infraestrutura
Operador --> DockerCompose : Deploy/Orquestração
DockerCompose --> CacheVolumes : Montagem

@enduml